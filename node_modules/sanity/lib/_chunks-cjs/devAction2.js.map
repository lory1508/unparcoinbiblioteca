{"version":3,"file":"devAction2.js","sources":["../../src/_internal/cli/server/devServer.ts","../../src/_internal/cli/actions/dev/devAction.ts"],"sourcesContent":["import {type ReactCompilerConfig, type UserViteConfig} from '@sanity/cli'\nimport chalk from 'chalk'\n\nimport {debug} from './debug'\nimport {extendViteConfigWithUserConfig, getViteConfig} from './getViteConfig'\nimport {writeSanityRuntime} from './runtime'\n\nexport interface DevServerOptions {\n  cwd: string\n  basePath: string\n  staticPath: string\n\n  httpPort: number\n  httpHost?: string\n  projectName?: string\n\n  reactStrictMode: boolean\n  reactCompiler: ReactCompilerConfig | undefined\n  vite?: UserViteConfig\n  appLocation?: string\n  isApp?: boolean\n  skipStartLog?: boolean\n}\n\nexport interface DevServer {\n  close(): Promise<void>\n}\n\nexport async function startDevServer(options: DevServerOptions): Promise<DevServer> {\n  const {\n    cwd,\n    httpPort,\n    httpHost,\n    basePath,\n    reactStrictMode,\n    vite: extendViteConfig,\n    reactCompiler,\n    appLocation,\n    isApp,\n    skipStartLog,\n  } = options\n\n  const startTime = Date.now()\n  debug('Writing Sanity runtime files')\n  await writeSanityRuntime({cwd, reactStrictMode, watch: true, basePath, appLocation, isApp})\n\n  debug('Resolving vite config')\n  const mode = 'development'\n\n  let viteConfig = await getViteConfig({\n    basePath,\n    mode: 'development',\n    server: {port: httpPort, host: httpHost},\n    cwd,\n    reactCompiler,\n    isApp,\n  })\n\n  // Extend Vite configuration with user-provided config\n  if (extendViteConfig) {\n    viteConfig = await extendViteConfigWithUserConfig(\n      {command: 'serve', mode},\n      viteConfig,\n      extendViteConfig,\n    )\n  }\n\n  debug('Creating vite server')\n  const {createServer} = await import('vite')\n  const server = await createServer(viteConfig)\n  const info = server.config.logger.info\n\n  debug('Listening on specified port')\n  await server.listen()\n\n  if (!skipStartLog) {\n    const startupDuration = Date.now() - startTime\n    const url = `http://${httpHost || 'localhost'}:${httpPort || '3333'}${basePath}`\n    const appType = isApp ? 'Sanity application' : 'Sanity Studio'\n    info(\n      `${appType} ` +\n        `using ${chalk.cyan(`vite@${require('vite/package.json').version}`)} ` +\n        `ready in ${chalk.cyan(`${Math.ceil(startupDuration)}ms`)} ` +\n        `and running at ${chalk.cyan(url)}`,\n    )\n  }\n  return {close: () => server.close()}\n}\n","import path from 'node:path'\n\nimport {\n  type CliCommandArguments,\n  type CliCommandContext,\n  type CliConfig,\n  type CliOutputter,\n} from '@sanity/cli'\nimport {type SanityProject} from '@sanity/client'\nimport chalk from 'chalk'\nimport {hideBin} from 'yargs/helpers'\nimport yargs from 'yargs/yargs'\n\nimport {type DevServerOptions, startDevServer} from '../../server/devServer'\nimport {checkRequiredDependencies} from '../../util/checkRequiredDependencies'\nimport {checkStudioDependencyVersions} from '../../util/checkStudioDependencyVersions'\nimport {getSharedServerConfig, gracefulServerDeath} from '../../util/servers'\nimport {getTimer} from '../../util/timing'\n\nexport interface StartDevServerCommandFlags {\n  'host'?: string\n  'port'?: string\n  'load-in-dashboard'?: boolean\n  'force'?: boolean\n}\n\nexport const getCoreURL = (): string => {\n  return process.env.SANITY_INTERNAL_ENV === 'staging'\n    ? 'https://core.sanity.work'\n    : 'https://core.sanity.io'\n}\n\nexport const getCoreAppURL = ({\n  organizationId,\n  httpHost = 'localhost',\n  httpPort = 3333,\n}: {\n  organizationId: string\n  httpHost?: string\n  httpPort?: number\n}): string => {\n  // <core-app-url>/<orgniazationId>?dev=<dev-server-url>\n  return `${getCoreURL()}/@${organizationId}?dev=http://${httpHost}:${httpPort}`\n}\n\nfunction parseCliFlags(args: {argv?: string[]}) {\n  // Using slice(1) to remove the first argument, which is the command `dev` path to the CLI\n  return yargs(hideBin(args.argv || process.argv).slice(1))\n    .options('host', {type: 'string'})\n    .options('port', {type: 'number'})\n    .option('load-in-dashboard', {type: 'boolean', default: false}).argv\n}\n\nexport default async function startSanityDevServer(\n  args: CliCommandArguments<StartDevServerCommandFlags>,\n  context: CliCommandContext,\n): Promise<void> {\n  const timers = getTimer()\n  const flags = await parseCliFlags(args)\n  const {output, apiClient, workDir, cliConfig} = context\n\n  const {loadInDashboard} = flags\n\n  timers.start('checkStudioDependencyVersions')\n  checkStudioDependencyVersions(workDir)\n  timers.end('checkStudioDependencyVersions')\n\n  // If the check resulted in a dependency install, the CLI command will be re-run,\n  // thus we want to exit early\n  if ((await checkRequiredDependencies(context)).didInstall) {\n    return\n  }\n\n  // Try to load CLI configuration from sanity.cli.(js|ts)\n  const config = getDevServerConfig({flags, workDir, cliConfig, output})\n\n  const projectId = cliConfig?.api?.projectId\n  let organizationId: string | undefined | null\n\n  if (loadInDashboard) {\n    if (!projectId) {\n      output.error('Project Id is required to load in dashboard')\n      process.exit(1)\n    }\n\n    const client = apiClient({\n      requireUser: true,\n      requireProject: true,\n    })\n\n    try {\n      const project = await client.request<SanityProject>({uri: `/projects/${projectId}`})\n      organizationId = project.organizationId\n    } catch (err) {\n      output.error('Failed to get organization Id from project Id')\n      process.exit(1)\n    }\n  }\n\n  try {\n    const spinner = output.spinner('Starting dev server').start()\n    await startDevServer({...config, skipStartLog: loadInDashboard})\n    spinner.succeed()\n\n    if (loadInDashboard) {\n      if (!organizationId) {\n        output.error('Organization Id not found for project')\n        process.exit(1)\n      }\n\n      output.print(`Dev server started on ${config.httpPort} port`)\n      output.print(`View your app in the Sanity dashboard here:`)\n      output.print(\n        chalk.blue(\n          chalk.underline(\n            getCoreAppURL({\n              organizationId,\n              httpHost: config.httpHost,\n              httpPort: config.httpPort,\n            }),\n          ),\n        ),\n      )\n    }\n  } catch (err) {\n    gracefulServerDeath('dev', config.httpHost, config.httpPort, err)\n  }\n}\n\nexport function getDevServerConfig({\n  flags,\n  workDir,\n  cliConfig,\n  output,\n}: {\n  flags: Awaited<ReturnType<typeof parseCliFlags>>\n  workDir: string\n  cliConfig?: CliConfig\n  output: CliOutputter\n}): DevServerOptions {\n  const configSpinner = output.spinner('Checking configuration files...')\n  const baseConfig = getSharedServerConfig({\n    flags: {\n      host: flags.host,\n      port: flags.port,\n    },\n    workDir,\n    cliConfig,\n  })\n  configSpinner.succeed()\n\n  const env = process.env // eslint-disable-line no-process-env\n  const reactStrictMode = env.SANITY_STUDIO_REACT_STRICT_MODE\n    ? env.SANITY_STUDIO_REACT_STRICT_MODE === 'true'\n    : Boolean(cliConfig?.reactStrictMode)\n\n  if (env.SANITY_STUDIO_BASEPATH && cliConfig?.project?.basePath) {\n    output.warn(\n      `Overriding configured base path (${cliConfig.project.basePath}) with value from environment variable (${env.SANITY_STUDIO_BASEPATH})`,\n    )\n  }\n\n  return {\n    ...baseConfig,\n    staticPath: path.join(workDir, 'static'),\n    reactStrictMode,\n    reactCompiler: cliConfig && 'reactCompiler' in cliConfig ? cliConfig.reactCompiler : undefined,\n  }\n}\n"],"names":["startDevServer","options","cwd","httpPort","httpHost","basePath","reactStrictMode","vite","extendViteConfig","reactCompiler","appLocation","isApp","skipStartLog","startTime","Date","now","debug","writeSanityRuntime","watch","mode","viteConfig","getViteConfig","server","port","host","extendViteConfigWithUserConfig","command","createServer","info","config","logger","listen","startupDuration","url","chalk","cyan","require","version","Math","ceil","close","getCoreURL","process","env","SANITY_INTERNAL_ENV","getCoreAppURL","organizationId","parseCliFlags","args","yargs","hideBin","argv","slice","type","option","default","startSanityDevServer","context","timers","getTimer","flags","output","apiClient","workDir","cliConfig","loadInDashboard","start","checkStudioDependencyVersions","end","checkRequiredDependencies","didInstall","getDevServerConfig","projectId","api","error","exit","client","requireUser","requireProject","request","uri","spinner","succeed","print","blue","underline","err","gracefulServerDeath","configSpinner","baseConfig","getSharedServerConfig","SANITY_STUDIO_REACT_STRICT_MODE","Boolean","SANITY_STUDIO_BASEPATH","project","warn","staticPath","path","join","undefined"],"mappings":"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"}